<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Kiro - Envío de ubicación e info dispositivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <style>
    .spinner {
      margin: 20px auto;
      width: 40px;
      height: 40px;
      border: 5px solid #ccc;
      border-top-color: #00aaff; /* color celeste */
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">
  <h2>¡Gracias por encontrar a Kiro!🧡</h2>
    <p>Serás redirigido automáticamente. Por favor, espera unos segundos...</p>

  
    <div class="spinner"></div>
  
<script>
  // --- Detectores y utilidades ---
  function parseUserAgent(ua) {
    ua = ua.toLowerCase();

    let marcaModelo = "Desconocido";
    let so = "Desconocido";

    // Sistema operativo (SO)
    if (/android/.test(ua)) so = "Android";
    else if (/iphone|ipad|ipod/.test(ua)) so = "iOS";
    else if (/windows phone/.test(ua)) so = "Windows Phone";
    else if (/windows/.test(ua)) so = "Windows";
    else if (/mac os/.test(ua)) so = "Mac OS";
    else if (/linux/.test(ua)) so = "Linux";

    // Marcas y modelos comunes
    if (/samsung/.test(ua)) marcaModelo = "Samsung";
    else if (/huawei/.test(ua)) marcaModelo = "Huawei";
    else if (/iphone/.test(ua)) marcaModelo = "iPhone";
    else if (/ipad/.test(ua)) marcaModelo = "iPad";
    else if (/xiaomi/.test(ua)) marcaModelo = "Xiaomi";
    else if (/oneplus/.test(ua)) marcaModelo = "OnePlus";
    else if (/pixel/.test(ua)) marcaModelo = "Google Pixel";
    else if (/motorola/.test(ua)) marcaModelo = "Motorola";
    else if (/lg/.test(ua)) marcaModelo = "LG";
    else if (/sony/.test(ua)) marcaModelo = "Sony";
    else if (/oppo/.test(ua)) marcaModelo = "Oppo";
    else if (/realme/.test(ua)) marcaModelo = "Realme";
    else if (/vivo/.test(ua)) marcaModelo = "Vivo";
    else if (/nokia/.test(ua)) marcaModelo = "Nokia";
    else if (/asus/.test(ua)) marcaModelo = "Asus";

    return { marcaModelo, so };
  }

  // Consentimiento y almacenamiento
  function tieneConsentimiento() {
    return localStorage.getItem("consentimientoUbicacion") === "true";
  }
  function setConsentimiento() {
    localStorage.setItem("consentimientoUbicacion", "true");
  }

  // Contador y fecha del escaneo
  function incrementarContador() {
    let contador = parseInt(localStorage.getItem("contadorEscaneos") || "0", 10);
    contador++;
    localStorage.setItem("contadorEscaneos", contador.toString());
    return contador;
  }
  function actualizarFecha() {
    const fechaActual = new Date().toISOString();
    localStorage.setItem("ultimaFechaEscaneo", fechaActual);
    return fechaActual;
  }

  // --- Envío de la ubicación a Formspree ---
  function enviarUbicacion(lat, lon) {
    const linkGoogleMaps = `https://www.google.com/maps?q=${lat},${lon}`;
    const uaInfo = parseUserAgent(navigator.userAgent);
    const contador = incrementarContador();
    const ultimaFecha = actualizarFecha();

    let mensaje = `El collar de Kiro fue encontrado en:\n${linkGoogleMaps}\n\n` +
      `Información del dispositivo:\nMarca/Modelo: ${uaInfo.marcaModelo}\nSistema operativo: ${uaInfo.so}\n\n` +
      `Escaneo número: ${contador}\nÚltima fecha de escaneo: ${ultimaFecha}`;

    fetch("https://formspree.io/f/meozvdjo", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({
        email: "pamunoz.s97@gmail.com",
        message: mensaje
      })
    })
    .then(response => {
      console.log("Ubicación e info enviada con éxito");
      // Mantengo el comportamiento anterior: redirigir después de 3s
      setTimeout(() => {
        window.location.href = "https://sites.google.com/view/kiromunozslimming/contacto";
      }, 3000);
    })
    .catch(error => {
      console.error("Error al enviar:", error);
      setTimeout(() => {
        window.location.href = "https://sites.google.com/view/kiromunozslimming/contacto";
      }, 3000);
    });
  }

  // --- Obtención de ubicación con UN reintento si falla por GPS apagado/permiso ---
  let yaReintento = false; // controla que solo haya un reintento

  function obtenerUbicacion() {
    if (!("geolocation" in navigator)) {
      alert("Geolocalización no soportada.");
      window.location.href = "https://sites.google.com/view/kiromunozslimming/contacto";
      return;
    }

    // Función que intenta obtener la posición (la llamamos la primera vez y, si hace falta, una vez más)
    const intentarObtener = () => {
      navigator.geolocation.getCurrentPosition(
        position => {
          // Si no había consentimiento previo, lo guardamos ahora
          if (!tieneConsentimiento()) setConsentimiento();

          // Enviamos la ubicación
          enviarUbicacion(position.coords.latitude, position.coords.longitude);
        },
        error => {
          // Si aún no reintentamos, pedimos al usuario activar GPS y reintentamos una vez
          if (!yaReintento) {
            yaReintento = true;
            // Mensaje claro para que active GPS/configuración y luego pulse Aceptar
            alert("No se pudo obtener la ubicación. Por favor activa tu GPS (o permisos de ubicación) y presiona Aceptar para intentarlo de nuevo.");
            // Esperamos un par de segundos para que el sistema registre el cambio y luego reintentamos
            setTimeout(() => {
              intentarObtener();
            }, 2000);
          } else {
            // Ya reintentamos una vez: redirigimos a la página de contacto
            alert("No se pudo obtener la ubicación. Serás redirigido a la página de contacto.");
            window.location.href = "https://sites.google.com/view/kiromunozslimming/contacto";
          }
        },
        { enableHighAccuracy: true, timeout: 7000 }
      );
    };

    // Comenzamos la primera tentativa
    intentarObtener();
  }

  // Ejecuta al cargar
  obtenerUbicacion();
</script>
</body>
</html>