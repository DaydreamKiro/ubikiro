<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Kiro - Envío de ubicación e info dispositivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">
  <h2>¡Gracias por encontrar a Kiro!🧡</h2>
    <p>Por favor, acepta compartir tu ubicación solo un momento. 
    Nos ayudaría a localizarlo más rápido</p>

<script>
  function parseUserAgent(ua) {
    ua = ua.toLowerCase();

    let marcaModelo = "Desconocido";
    let so = "Desconocido";

    // Sistema operativo (SO)
    if (/android/.test(ua)) so = "Android";
    else if (/iphone|ipad|ipod/.test(ua)) so = "iOS";
    else if (/windows phone/.test(ua)) so = "Windows Phone";
    else if (/windows/.test(ua)) so = "Windows";
    else if (/mac os/.test(ua)) so = "Mac OS";
    else if (/linux/.test(ua)) so = "Linux";

    // Marcas y modelos comunes
    if (/samsung/.test(ua)) marcaModelo = "Samsung";
    else if (/huawei/.test(ua)) marcaModelo = "Huawei";
    else if (/iphone/.test(ua)) marcaModelo = "iPhone";
    else if (/ipad/.test(ua)) marcaModelo = "iPad";
    else if (/xiaomi/.test(ua)) marcaModelo = "Xiaomi";
    else if (/oneplus/.test(ua)) marcaModelo = "OnePlus";
    else if (/pixel/.test(ua)) marcaModelo = "Google Pixel";
    else if (/motorola/.test(ua)) marcaModelo = "Motorola";
    else if (/lg/.test(ua)) marcaModelo = "LG";
    else if (/sony/.test(ua)) marcaModelo = "Sony";
    else if (/oppo/.test(ua)) marcaModelo = "Oppo";
    else if (/realme/.test(ua)) marcaModelo = "Realme";
    else if (/vivo/.test(ua)) marcaModelo = "Vivo";
    else if (/nokia/.test(ua)) marcaModelo = "Nokia";
    else if (/asus/.test(ua)) marcaModelo = "Asus";

    return { marcaModelo, so };
  }

  // Consentimiento y almacenamiento
  function tieneConsentimiento() {
    return localStorage.getItem("consentimientoUbicacion") === "true";
  }
  function setConsentimiento() {
    localStorage.setItem("consentimientoUbicacion", "true");
  }

  // Contador y fecha del escaneo
  function incrementarContador() {
    let contador = parseInt(localStorage.getItem("contadorEscaneos") || "0", 10);
    contador++;
    localStorage.setItem("contadorEscaneos", contador.toString());
    return contador;
  }
  function actualizarFecha() {
    const fechaActual = new Date().toISOString();
    localStorage.setItem("ultimaFechaEscaneo", fechaActual);
    return fechaActual;
  }

  function enviarUbicacion(lat, lon) {
    const linkGoogleMaps = `https://www.google.com/maps?q=${lat},${lon}`;
    const uaInfo = parseUserAgent(navigator.userAgent);
    const contador = incrementarContador();
    const ultimaFecha = actualizarFecha();

    let mensaje = `El collar de Kiro fue encontrado en:\n${linkGoogleMaps}\n\n` +
      `Información del dispositivo:\nMarca/Modelo: ${uaInfo.marcaModelo}\nSistema operativo: ${uaInfo.so}\n\n` +
      `Escaneo número: ${contador}\nÚltima fecha de escaneo: ${ultimaFecha}`;

    fetch("https://formspree.io/f/meozvdjo", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({
        email: "pamunoz.s97@gmail.com",
        message: mensaje
      })
    })
    .then(response => {
      console.log("Ubicación e info enviada con éxito");
      setTimeout(() => {
        window.location.href = "https://sites.google.com/view/kiromunozslimming";
      }, 5000);
    })
    .catch(error => {
      console.error("Error al enviar:", error);
      setTimeout(() => {
        window.location.href = "https://sites.google.com/view/kiromunozslimming";
      }, 5000);
    });
  }

  function obtenerUbicacion() {
    if (!("geolocation" in navigator)) {
      alert("Geolocalización no soportada.");
      window.location.href = "https://sites.google.com/view/kiromunozslimming";
      return;
    }

    if (tieneConsentimiento()) {
      navigator.geolocation.getCurrentPosition(
        position => {
          enviarUbicacion(position.coords.latitude, position.coords.longitude);
        },
        error => {
          alert("No se pudo obtener la ubicación.");
          window.location.href = "https://sites.google.com/view/kiromunozslimming";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } else {
      navigator.geolocation.getCurrentPosition(
        position => {
          setConsentimiento();
          enviarUbicacion(position.coords.latitude, position.coords.longitude);
        },
        error => {
          alert("No se pudo obtener la ubicación o no se concedió permiso.");
          window.location.href = "https://sites.google.com/view/kiromunozslimming";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
  }

  obtenerUbicacion();
</script>
</body>
</html>
